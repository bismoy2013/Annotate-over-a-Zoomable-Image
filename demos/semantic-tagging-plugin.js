annotorious.plugin.SemanticTagging=function(opt_config_options){this._tags=[];this._ENDPOINT_URI=opt_config_options["endpoint_url"];if(this._ENDPOINT_URI[this._ENDPOINT_URI.length-1]!="/")this._ENDPOINT_URI+="/";this._ENDPOINT_URI+="services/wikify?minProbability=0.1&disambiguationPolicy=loose&responseFormat=json&source="};annotorious.plugin.SemanticTagging.prototype.onInitAnnotator=function(annotator){this._extendPopup(annotator);this._extendEditor(annotator)};annotorious.plugin.SemanticTagging.prototype._extendEditor=function(annotator){var self=this,container=document.createElement("div"),idle_timeout,MIN_TEXT_LENGTH=5,TRIGGER_CHARS=". ,",IDLE_THRESHOLD=500;container.className="semtagging-editor-container";var addTag=function(annotation,topic,opt_css_class){self._tags[topic.id]=topic;var link=document.createElement("a");link.style.cursor="pointer";link.className="semtagging-tag semtagging-editor-tag";link.innerHTML=topic.title;container.appendChild(link);var jqLink=jQuery(link);if(opt_css_class)jqLink.addClass(opt_css_class);jqLink.click(function(){if(!annotation.tags)annotation.tags=[];if(jqLink.hasClass("accepted")){jqLink.toggleClass("accepted rejected");topic.status="rejected"}else if(jqLink.hasClass("rejected")){jqLink.removeClass("rejected");delete topic.status;var idx=annotation.tags.indexOf(topic);if(idx>-1)annotation.tags.splice(idx,1)}else{jqLink.addClass("accepted");delete topic.status;annotation.tags.push(topic)}})};var doNER=function(annotation,text){jQuery.getJSON(self._ENDPOINT_URI+text,function(data){if(data.detectedTopics.length>0){jQuery.each(data.detectedTopics,function(idx,topic){if(!self._tags[topic.id])addTag(annotation,topic)})}})};var restartIdleTimeout=function(annotation,text){if(idle_timeout)window.clearTimeout(idle_timeout);idle_timeout=window.setTimeout(function(){doNER(annotation,text)},IDLE_THRESHOLD)};annotator.editor.element.addEventListener("keyup",function(event){var annotation=annotator.editor.getAnnotation(),text=annotation.text;if(text.length>MIN_TEXT_LENGTH){restartIdleTimeout(annotation,text);if(TRIGGER_CHARS.indexOf(text[text.length-1])>-1)doNER(annotation,text)}});annotator.editor.addField(function(annotation){self._tags=[];container.innerHTML="";if(annotation&&annotation.tags){jQuery.each(annotation.tags,function(idx,topic){var css_class=topic.status=="rejected"?"rejected":"accepted";addTag(annotation,topic,css_class)})}return container})};annotorious.plugin.SemanticTagging.prototype._extendPopup=function(annotator){annotator.popup.addField(function(annotation){var popupContainer=document.createElement("div");if(annotation.tags){jQuery.each(annotation.tags,function(idx,tag){var el=document.createElement("a");el.href="#";el.className="semtagging-tag semtagging-popup-tag";el.innerHTML=tag.title;if(tag.status=="rejected")jQuery(el).addClass("rejected");else jQuery(el).addClass("accepted");popupContainer.appendChild(el)})}return popupContainer})};